{% extends "payroll_app/base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}

<div class="flex justify-between items-center p-6">
    <div class="flex items-center space-x-2 text-[#7768ae] font-semibold text-lg">
        <!-- User icon -->
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
             viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round"
                  d="M5.121 17.804A9 9 0 1112 21a9 9 0 01-6.879-3.196z"/>
        </svg>
        <span>Welcome, Admin</span>
    </div>

    <div class="flex items-center space-x-4">
        <!-- Search input -->
        <div class="flex items-center border rounded focus-within:ring-2 focus-within:ring-[#00b9b9]">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2 text-gray-400"
                 fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
            <input type="text" placeholder="Search..."
                   class="px-2 py-1 focus:outline-none">
        </div>
        <!-- Notification -->
        <div class="bg-[#ff9b4b] text-white px-3 py-1 rounded flex items-center space-x-1">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                 viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6 6 0 10-12 0v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
            </svg>
            <span>3</span>
        </div>
    </div>


    <!-- Month selector navigation -->
<div class="flex items-center space-x-3">
    <button id="prevMonth" class="px-2 py-1 bg-[#7768ae] text-white rounded">◀</button>
    <span id="monthDisplay" class="text-[#7768ae] font-semibold"></span>
    <button id="nextMonth" class="px-2 py-1 bg-[#7768ae] text-white rounded">▶</button>
</div>

</div>

<!-- Stats Cards with flat icons -->
<div class="grid grid-cols-4 gap-6 px-6 mb-6">
    <div class="bg-white p-4 rounded shadow text-center flex flex-col items-center justify-center space-y-1">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-[#00b9b9]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
        <h2 class="text-[#00b9b9] font-semibold">Total Employees</h2>
        <p class="text-2xl font-bold">{{ total_employees }}</p>
    </div>

    <div class="bg-white p-4 rounded shadow text-center flex flex-col items-center justify-center space-y-1">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-[#ff9b4b]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        <h2 class="text-[#00b9b9] font-semibold">Add New Employee</h2>
        <a href="{% url 'add_employee' %}" class="mt-2 px-3 py-1 bg-[#ff9b4b] text-white rounded hover:bg-[#7768ae] inline-block">Add</a>
    </div>

    <div class="bg-white p-4 rounded shadow text-center flex flex-col items-center justify-center space-y-1">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-[#00b9b9]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4" />
        </svg>
        <h2 class="text-[#00b9b9] font-semibold">Hired Candidates</h2>
        <p class="text-2xl font-bold">12</p>
    </div>

    <div class="bg-white p-4 rounded shadow text-center flex flex-col items-center justify-center space-y-1">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-[#00b9b9]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-3 0-5 2-5 5s2 5 5 5 5-2 5-5-2-5-5-5z" />
        </svg>
        <h2 class="text-[#00b9b9] font-semibold">Net Salary</h2>
        <p class="text-2xl font-bold">₹{{ net_salary_total }}</p>
    </div>
</div>


<!-- Calendar & Schedule Meeting -->
<div class="grid grid-cols-3 gap-6 px-6 mb-6">
    <div class="col-span-2 bg-white p-4 rounded shadow">
          <h2 id="calendarTitle" class="text-[#7768ae] font-semibold mb-2"></h2>
        <div id="calendar" class="grid grid-cols-7 gap-1"></div>
    </div>
    <div class="bg-white p-4 rounded shadow">
        <h2 class="text-[#7768ae] font-semibold mb-2">Schedule Meeting</h2>
        <form method="POST" action="{% url 'add_meeting' %}" class="space-y-3">
            {% csrf_token %}
            <input type="datetime-local" name="meeting_time" class="w-full px-3 py-1 border rounded focus:ring-2 focus:ring-[#00b9b9]">
            <textarea name="meeting_info" placeholder="Meeting Info" class="w-full px-3 py-1 border rounded focus:ring-2 focus:ring-[#00b9b9]"></textarea>
            <button type="submit" class="w-full py-1 bg-[#ff9b4b] text-white rounded hover:bg-[#7768ae]">Schedule</button>
        </form>
    </div>
</div>

<!-- Salary Distribution Chart -->
<div class="px-6 mb-6 bg-white p-4 rounded shadow">
    <h2 class="text-[#7768ae] font-semibold mb-2">Salary Distribution</h2>
    <canvas id="salaryChart" class="h-64 w-full"></canvas>
</div>

<!-- JSON-safe meetings and chart data -->
{{ meetings_by_date|json_script:"meetings-data" }}
{{ chart_data|json_script:"chart-data" }}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Parse meetings from JSON
let meetingsByDate = JSON.parse(document.getElementById('meetings-data').textContent);
const ctx = document.getElementById('salaryChart').getContext('2d');

const employeeNames = ['Alice', 'Bob', 'Charlie', 'David', 'Eva'];
const employeeSalaries = [50000, 60000, 45000, 70000, 55000];

// Helper: format date as YYYY-MM-DD
function formatDateLocal(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// Track selected date
let currentDate = new Date();

// Render calendar function
function renderCalendar(selectedYear, selectedMonth) {
    const calendarEl = document.getElementById('calendar');
    calendarEl.innerHTML = '';

    const year = selectedYear;
    const month = selectedMonth;

    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);

    // Update top month display
    const options = { month: "long", year: "numeric" };
    document.getElementById("monthDisplay").textContent =
        currentDate.toLocaleDateString("en-US", options);

    // Weekdays header
    ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(day => {
        const dayEl = document.createElement('div');
        dayEl.classList.add('font-bold','text-center');
        dayEl.textContent = day;
        calendarEl.appendChild(dayEl);
    });

    // Empty slots before first day
    for (let i = 0; i < firstDay.getDay(); i++) {
        calendarEl.appendChild(document.createElement('div'));
    }

    // Days
    for (let d = 1; d <= lastDay.getDate(); d++) {
        const dateObj = new Date(year, month, d);
        const dateStr = formatDateLocal(dateObj);

        const dayEl = document.createElement('div');
        dayEl.classList.add('border','p-1','h-20','overflow-auto','rounded','cursor-pointer');

        const dayNumber = document.createElement('div');
        dayNumber.classList.add('font-bold','text-sm');
        dayNumber.textContent = d;
        dayEl.appendChild(dayNumber);

        // Show meetings
        if (meetingsByDate[dateStr]) {
            meetingsByDate[dateStr].forEach(info => {
                const meetingEl = document.createElement('div');
                meetingEl.classList.add('bg-[#ff9b4b]','text-white','text-xs','rounded','my-1','px-1');
                meetingEl.textContent = info;
                dayEl.appendChild(meetingEl);
            });
        }

        // Click day → update meeting form + top text
        dayEl.addEventListener('click', () => {
            const inputEl = document.querySelector('input[name="meeting_time"]');
            inputEl.value = dateStr + 'T09:00';

            document.getElementById("monthDisplay").textContent =
                `${currentDate.toLocaleDateString("en-US", options)} - Selected: ${d}`;
        });

        calendarEl.appendChild(dayEl);
    }
}

// Helpers to render current
function renderCalendarForCurrent() {
    renderCalendar(currentDate.getFullYear(), currentDate.getMonth());
}

// Arrow buttons
document.getElementById("prevMonth").addEventListener("click", () => {
    currentDate.setMonth(currentDate.getMonth() - 1);
    renderCalendarForCurrent();
});

document.getElementById("nextMonth").addEventListener("click", () => {
    currentDate.setMonth(currentDate.getMonth() + 1);
    renderCalendarForCurrent();
});

// Initial render
renderCalendarForCurrent();


// Salary chart
new Chart(ctx, {
    type: 'bar',
    data: {
        labels: employeeNames,
        datasets: [{
            label: 'Net Salary',
            data: employeeSalaries,
            backgroundColor: 'rgba(0, 185, 185, 0.7)',
            borderColor: 'rgba(0, 185, 185, 1)',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
            y: {
                beginAtZero: true,
                ticks: { stepSize: 10000 }
            }
        }
    }
});
</script>



{% endblock %}
